<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test MQTT Scan</title>
</head>
<body>
    <h1>MQTT Scanner Test</h1>
    <button id="testScanBtn">Test Scan Sensors</button>
    <div id="results" style="margin-top: 20px; padding: 10px; border: 1px solid #ccc;"></div>

    <script>
        document.getElementById('testScanBtn').addEventListener('click', async function() {
            console.log('Testing scan sensors...');
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<p>Testing scan...</p>';
            
            try {
                // Test Flask API directly first
                console.log('Testing Flask API directly...');
                
                const flaskResponse = await fetch('http://127.0.0.1:5000/api/scan', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-KEY': 'my-very-secret-flask-key-CHANGEME'
                    },
                    body: JSON.stringify({
                        target: '127.0.0.1',
                        listen_duration: 3,
                        capture_all_topics: true,
                        creds: {
                            user: 'testuser',
                            pass: 'testpass'
                        }
                    })
                });
                
                const flaskData = await flaskResponse.json();
                console.log('Flask API response:', flaskData);
                
                resultsDiv.innerHTML = '<h3>Flask API Test Result:</h3><pre>' + JSON.stringify(flaskData, null, 2) + '</pre>';
                
                if (flaskData.job_id) {
                    // Poll for results
                    setTimeout(async () => {
                        try {
                            const statusResponse = await fetch(`http://127.0.0.1:5000/api/scan/${flaskData.job_id}/status`, {
                                headers: {
                                    'X-API-KEY': 'my-very-secret-flask-key-CHANGEME'
                                }
                            });
                            const statusData = await statusResponse.json();
                            
                            resultsDiv.innerHTML += '<h3>Job Status:</h3><pre>' + JSON.stringify(statusData, null, 2) + '</pre>';
                            
                            if (statusData.status === 'completed') {
                                const resultsResponse = await fetch(`http://127.0.0.1:5000/api/scan/${flaskData.job_id}/results`, {
                                    headers: {
                                        'X-API-KEY': 'my-very-secret-flask-key-CHANGEME'
                                    }
                                });
                                const resultsData = await resultsResponse.json();
                                
                                resultsDiv.innerHTML += '<h3>Scan Results:</h3><pre>' + JSON.stringify(resultsData, null, 2) + '</pre>';
                            }
                        } catch (error) {
                            console.error('Error checking status:', error);
                            resultsDiv.innerHTML += '<p style="color: red;">Error checking status: ' + error.message + '</p>';
                        }
                    }, 5000);
                }
                
            } catch (error) {
                console.error('Error:', error);
                resultsDiv.innerHTML = '<p style="color: red;">Error: ' + error.message + '</p>';
            }
        });
    </script>
</body>
</html>